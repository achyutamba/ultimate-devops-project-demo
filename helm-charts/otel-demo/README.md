# otel-demo Helm Chart

Deploy the OpenTelemetry Demo microservices stack onto AKS (or any Kubernetes cluster) using a single Helm release, with environment‑specific overrides, optional ingress, autoscaling, and feature flags via flagd.

## Features

* All demo microservices templated (frontend, checkout, cart, productcatalog, recommendation, quote, payment, shipping, ad, accounting, currency, email, imageprovider, loadgenerator, flagd, frauddetection, kafka, valkey, frontendproxy)
* Environment overrides (`values-dev.yaml`, `values-staging.yaml`, `values-production.yaml`)
* Conditional ingress for `frontendproxy`
* Flagd configuration via a ConfigMap (`flagd-configmap.yaml`)
* Global security and resource defaults (can be overridden per service)
* Ready for integration with Azure DevOps CD pipeline (namespaces + value files)

## Installing

```bash
helm upgrade --install otel-demo ./helm-charts/otel-demo \
  --namespace otel-demo-dev \
  --create-namespace \
  -f helm-charts/otel-demo/values-dev.yaml
```

Staging / Production:
```bash
helm upgrade --install otel-demo ./helm-charts/otel-demo \
  -n otel-demo-staging -f helm-charts/otel-demo/values-staging.yaml

helm upgrade --install otel-demo ./helm-charts/otel-demo \
  -n otel-demo-prod -f helm-charts/otel-demo/values-production.yaml
```

## Structure Overview

| Component | File(s) |
|-----------|---------|
| Chart metadata | `Chart.yaml` |
| Global & service values | `values.yaml` + env overrides |
| Deployments & Services | `templates/*-deployment.yaml`, `templates/*-service.yaml` |
| Flagd feature flags | `templates/flagd-configmap.yaml` |
| Ingress (optional) | `templates/frontendproxy-ingress.yaml` |
| ServiceAccount | `templates/serviceaccount.yaml` |

## Values Highlights

Global defaults (in `values.yaml`):
```yaml
global:
  podAnnotations: {}
  podSecurityContext: {}
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 500m
      memory: 256Mi
```

Override per service:
```yaml
frontend:
  replicaCount: 2
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 1000m
      memory: 512Mi
```

Flagd raw JSON flags (example – place in env values file):
```yaml
flagd:
  config:
    raw: |
      {"$schema":"https://flagd.dev/schema/v0/flags.json","flags":{}}
```

Frontend proxy ingress enable:
```yaml
frontendproxy:
  ingress:
    enabled: true
    className: nginx
    hosts:
      - host: shop.example.com
        paths:
          - path: /
            pathType: Prefix
```

## Autoscaling
HorizontalPodAutoscalers can be generated by enabling the `hpa.enabled` flag and listing desired services under `hpa.items` in `values.yaml` or an environment override file.

Example (already scaffolded in `values.yaml`):
```yaml
hpa:
  enabled: true
  items:
    - name: frontend
      minReplicas: 2
      maxReplicas: 6
      targetCPUUtilizationPercentage: 70
    - name: recommendation
      minReplicas: 2
      maxReplicas: 5
      targetCPUUtilizationPercentage: 75
```
Memory targets can be added with `targetMemoryUtilizationPercentage`. When enabled, each item renders an HPA referencing the corresponding Deployment (`<release>-<service>` naming convention).

## Network Policy (planned)
Will add optional template to restrict traffic. Toggle will look like:
```yaml
networkPolicy:
  enabled: true
```

## Flagd Notes
The flagd ConfigMap currently defaults to empty flags. Provide environment‑specific JSON under `flagd.config.raw` in the override files.

## Rollback
List history & rollback:
```bash
helm history otel-demo -n otel-demo-prod
helm rollback otel-demo <REVISION> -n otel-demo-prod
```

## Diff (Optional Plugin)
```bash
helm diff upgrade otel-demo ./helm-charts/otel-demo -f values-production.yaml -n otel-demo-prod
```

## Future Enhancements
* HorizontalPodAutoscaler templates
* NetworkPolicies
* StatefulSets for Kafka/Valkey if persistence required
* Secret & Config externalization of connection strings
* Prometheus & OTEL annotations toggle

## Contributing
Open PRs with changes; the CI should run `helm lint` and template render checks (to be added).

## License
See root `LICENSE`.