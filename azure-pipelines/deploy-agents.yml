# Deploy Azure Pipelines Agents to AKS
# This pipeline deploys self-hosted agents to the AKS cluster
# Agents run in the azure-pipelines namespace

trigger: none  # Manual trigger only

pr: none

variables:
  - group: otel-demo-dev

stages:
  - stage: DeployAgents
    displayName: 'Deploy Azure Pipelines Agents'
    jobs:
      - job: DeployToAKS
        displayName: 'Deploy Agents to AKS'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy Azure Pipelines Agents'
            inputs:
              azureSubscription: 'Azure-service1'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üîê Fetching PAT token from Key Vault..."
                PAT_TOKEN=$(az keyvault secret show \
                  --vault-name otel-demo-dev-kv \
                  --name azdevops-pat-token \
                  --query value -o tsv)
                
                if [ -z "$PAT_TOKEN" ]; then
                  echo "‚ùå ERROR: PAT token not found in Key Vault"
                  echo "Please run: az keyvault secret set --vault-name otel-demo-dev-kv --name azdevops-pat-token --value 'YOUR_PAT_TOKEN'"
                  exit 1
                fi
                
                echo "üîê Connecting to AKS cluster..."
                az aks get-credentials \
                  --resource-group $(DEV_RESOURCE_GROUP) \
                  --name $(DEV_AKS_CLUSTER) \
                  --overwrite-existing
                
                echo "üì¶ Creating namespace..."
                kubectl apply -f kubernetes/azure-agent/namespace.yaml
                
                echo "üîë Creating secret with PAT from Key Vault..."
                kubectl create secret generic azdevops-agent-secret \
                  --from-literal=AZP_URL="https://dev.azure.com/achyutaakella/otel-demo" \
                  --from-literal=AZP_TOKEN="$PAT_TOKEN" \
                  --from-literal=AZP_POOL="AKS-Agent-Pool" \
                  --namespace=azure-pipelines \
                  --dry-run=client -o yaml | kubectl apply -f -
                
                echo "üöÄ Deploying agent deployment..."
                kubectl apply -f kubernetes/azure-agent/deployment.yaml
                
                echo "‚è≥ Waiting for agents to be ready..."
                kubectl wait --for=condition=available --timeout=120s \
                  deployment/azdevops-agent -n azure-pipelines || true
                
                echo "‚úÖ Checking agent status..."
                kubectl get pods -n azure-pipelines
                
                echo ""
                echo "================================"
                echo "Azure Pipelines Agents Deployed!"
                echo "================================"
                echo "Namespace: azure-pipelines"
                echo "Deployment: azdevops-agent"
                echo "Agent Pool: AKS-Agent-Pool"
                echo ""
                echo "Next steps:"
                echo "1. Go to Azure DevOps ‚Üí Project Settings ‚Üí Agent pools ‚Üí AKS-Agent-Pool"
                echo "2. Verify agents are online"
                echo "3. Update CI pipeline to use pool: 'AKS-Agent-Pool'"
                echo "================================"

          - task: AzureCLI@2
            displayName: 'Verify Agent Logs'
            inputs:
              azureSubscription: 'Azure-service1'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üìã Agent logs (last 20 lines):"
                kubectl logs -n azure-pipelines deployment/azdevops-agent --tail=20 || echo "Logs not available yet"
